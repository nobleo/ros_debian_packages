name: builder

on:
  workflow_dispatch:
  push:

jobs:
  jazzy:
    runs-on: ubuntu-24.04
    steps:
      # https://github.com/jspricke/ros-deb-builder-action/issues/59
      # https://github.com/ros-infrastructure/bloom/pull/643
      # - uses: jspricke/ros-deb-builder-action@main
      - uses: nobleo/ros-deb-builder-action@debian-compat-13
        with:
          ROS_DISTRO: jazzy
          DEB_DISTRO: noble
          ROSDEP_SOURCE: "yaml https://github.com/nobleo/ros_debian_packages/raw/main/rosdep/source.yaml"
          # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} only on main branch
          GITHUB_TOKEN: "${{ github.ref == 'refs/heads/main' && secrets.GITHUB_TOKEN || '' }}"
          REPOS_FILE: jazzy.repos
          GIT_LFS: true
          SBUILD_CONF: '$enable_network = 1;'  # For rmw_zenoh and novatel
          # List generated by:
          # vcs import --input jazzy.repos
          # echo -e "$(colcon list --names-only)\n$(colcon list --names-only --packages-up-to \
          #   autoware_detected_object_feature_remover \
          #   autoware_detection_by_tracker \
          #   autoware_euclidean_cluster \
          #   autoware_ground_segmentation \
          #   autoware_object_merger \
          #   autoware_pointcloud_preprocessor \
          #   autoware_shape_estimation \
          #   autoware_perception_rviz_plugin \
          #   nebula_ros \
          #   )" | sort | uniq -u
          SKIP_PACKAGES: >-
            autoware_accel_brake_map_calibrator
            autoware_adapi_adaptors
            autoware_adapi_specs
            autoware_adapi_visualizers
            autoware_ar_tag_based_localizer
            autoware_auto_common
            autoware_automatic_pose_initializer
            autoware_autonomous_emergency_braking
            autoware_bag_time_manager_rviz_plugin
            autoware_behavior_path_avoidance_by_lane_change_module
            autoware_behavior_path_dynamic_obstacle_avoidance_module
            autoware_behavior_path_external_request_lane_change_module
            autoware_behavior_path_goal_planner_module
            autoware_behavior_path_lane_change_module
            autoware_behavior_path_planner
            autoware_behavior_path_planner_common
            autoware_behavior_path_sampling_planner_module
            autoware_behavior_path_side_shift_module
            autoware_behavior_path_start_planner_module
            autoware_behavior_path_static_obstacle_avoidance_module
            autoware_behavior_velocity_blind_spot_module
            autoware_behavior_velocity_crosswalk_module
            autoware_behavior_velocity_detection_area_module
            autoware_behavior_velocity_intersection_module
            autoware_behavior_velocity_no_drivable_lane_module
            autoware_behavior_velocity_no_stopping_area_module
            autoware_behavior_velocity_occlusion_spot_module
            autoware_behavior_velocity_planner
            autoware_behavior_velocity_planner_common
            autoware_behavior_velocity_rtc_interface
            autoware_behavior_velocity_run_out_module
            autoware_behavior_velocity_speed_bump_module
            autoware_behavior_velocity_stop_line_module
            autoware_behavior_velocity_template_module
            autoware_behavior_velocity_traffic_light_module
            autoware_behavior_velocity_virtual_traffic_light_module
            autoware_behavior_velocity_walkway_module
            autoware_bezier_sampler
            autoware_bluetooth_monitor
            autoware_bytetrack
            autoware_carla_interface
            autoware_cluster_merger
            autoware_collision_detector
            autoware_compare_map_segmentation
            autoware_component_interface_tools
            autoware_component_monitor
            autoware_component_state_monitor
            autoware_control_evaluator
            autoware_control_performance_analysis
            autoware_control_validator
            autoware_costmap_generator
            autoware_crosswalk_traffic_light_estimator
            autoware_default_adapi
            autoware_detected_object_validation
            autoware_diagnostic_graph_aggregator
            autoware_diagnostic_graph_utils
            autoware_dummy_diag_publisher
            autoware_dummy_infrastructure
            autoware_dummy_perception_publisher
            autoware_duplicated_node_checker
            autoware_ekf_localizer
            autoware_elevation_map_loader
            autoware_external_cmd_converter
            autoware_external_cmd_selector
            autoware_external_velocity_limit_selector
            autoware_fake_test_node
            autoware_fault_injection
            autoware_freespace_planner
            autoware_freespace_planning_algorithms
            autoware_frenet_planner
            autoware_geo_pose_projector
            autoware_geography_utils
            autoware_global_parameter_loader
            autoware_glog_component
            autoware_gnss_poser
            autoware_goal_distance_calculator
            autoware_grid_map_utils
            autoware_gyro_odometer
            autoware_hazard_status_converter
            autoware_image_diagnostics
            autoware_image_projection_based_fusion
            autoware_image_transport_decompressor
            autoware_imu_corrector
            autoware_joy_controller
            autoware_kalman_filter
            autoware_kinematic_evaluator
            autoware_landmark_manager
            autoware_lane_departure_checker
            autoware_lanelet2_map_visualizer
            autoware_learning_based_vehicle_model
            autoware_lidar_apollo_instance_segmentation
            autoware_lidar_centerpoint
            autoware_lidar_marker_localizer
            autoware_lidar_transfusion
            autoware_livox_tag_filter
            autoware_localization_error_monitor
            autoware_localization_evaluator
            autoware_localization_util
            autoware_map_based_prediction
            autoware_map_height_fitter
            autoware_map_loader
            autoware_map_projection_loader
            autoware_map_tf_generator
            autoware_mission_details_overlay_rviz_plugin
            autoware_mission_planner_universe
            autoware_motion_utils
            autoware_motion_velocity_dynamic_obstacle_stop_module
            autoware_motion_velocity_obstacle_cruise_module
            autoware_motion_velocity_obstacle_slow_down_module
            autoware_motion_velocity_obstacle_stop_module
            autoware_motion_velocity_obstacle_velocity_limiter_module
            autoware_motion_velocity_out_of_lane_module
            autoware_motion_velocity_planner_common_universe
            autoware_motion_velocity_planner_node_universe
            autoware_mpc_lateral_controller
            autoware_mrm_comfortable_stop_operator
            autoware_mrm_emergency_stop_operator
            autoware_mrm_handler
            autoware_multi_object_tracker
            autoware_ndt_scan_matcher
            autoware_node
            autoware_object_range_splitter
            autoware_object_velocity_splitter
            autoware_objects_of_interest_marker_interface
            autoware_obstacle_collision_checker
            autoware_obstacle_cruise_planner
            autoware_obstacle_stop_planner
            autoware_occupancy_grid_map_outlier_filter
            autoware_operation_mode_transition_manager
            autoware_osqp_interface
            autoware_overlay_rviz_plugin
            autoware_path_distance_calculator
            autoware_path_optimizer
            autoware_path_sampler
            autoware_path_smoother
            autoware_perception_online_evaluator
            autoware_pid_longitudinal_controller
            autoware_planning_evaluator
            autoware_planning_factor_interface
            autoware_planning_test_manager
            autoware_planning_topic_converter
            autoware_planning_validator
            autoware_polar_grid
            autoware_pose2twist
            autoware_pose_covariance_modifier
            autoware_pose_estimator_arbiter
            autoware_pose_initializer
            autoware_pose_instability_detector
            autoware_predicted_path_checker
            autoware_probabilistic_occupancy_grid_map
            autoware_processing_time_checker
            autoware_pure_pursuit
            autoware_qp_interface
            autoware_radar_crossing_objects_noise_filter
            autoware_radar_fusion_to_detected_object
            autoware_radar_object_clustering
            autoware_radar_object_tracker
            autoware_radar_scan_to_pointcloud2
            autoware_radar_static_pointcloud_filter
            autoware_radar_threshold_filter
            autoware_radar_tracks_msgs_converter
            autoware_radar_tracks_noise_filter
            autoware_raindrop_cluster_filter
            autoware_raw_vehicle_cmd_converter
            autoware_remaining_distance_time_calculator
            autoware_route_handler
            autoware_rtc_interface
            autoware_sampler_common
            autoware_scenario_selector
            autoware_scenario_simulator_v2_adapter
            autoware_shift_decider
            autoware_signal_processing
            autoware_simple_object_merger
            autoware_simple_planning_simulator
            autoware_smart_mpc_trajectory_follower
            autoware_steer_offset_estimator
            autoware_stop_filter
            autoware_string_stamped_rviz_plugin
            autoware_surround_obstacle_checker
            autoware_system_diagnostic_monitor
            autoware_system_monitor
            autoware_tensorrt_classifier
            autoware_tensorrt_yolox
            autoware_test_node
            autoware_testing
            autoware_time_utils
            autoware_topic_relay_controller
            autoware_topic_state_monitor
            autoware_tracking_object_merger
            autoware_traffic_light_arbiter
            autoware_traffic_light_classifier
            autoware_traffic_light_fine_detector
            autoware_traffic_light_map_based_detector
            autoware_traffic_light_multi_camera_fusion
            autoware_traffic_light_occlusion_predictor
            autoware_traffic_light_recognition_marker_publisher
            autoware_traffic_light_utils
            autoware_traffic_light_visualization
            autoware_trajectory
            autoware_trajectory_follower_base
            autoware_trajectory_follower_node
            autoware_twist2accel
            autoware_vehicle_cmd_gate
            autoware_vehicle_door_simulator
            autoware_vehicle_velocity_converter
            autoware_velocity_smoother
            autoware_velodyne_monitor
            nebula_examples
            nebula_sensor_driver
            nebula_tests
            perception_utils
            reaction_analyzer
            tier4_adapi_rviz_plugin
            tier4_api_msgs
            tier4_api_utils
            tier4_auto_msgs_converter
            tier4_autoware_api_launch
            tier4_camera_view_rviz_plugin
            tier4_control_launch
            tier4_datetime_rviz_plugin
            tier4_dummy_object_rviz_plugin
            tier4_external_api_msgs
            tier4_hmi_msgs
            tier4_localization_launch
            tier4_localization_rviz_plugin
            tier4_map_launch
            tier4_map_msgs
            tier4_metric_msgs
            tier4_perception_launch
            tier4_planning_factor_rviz_plugin
            tier4_planning_launch
            tier4_planning_rviz_plugin
            tier4_rtc_msgs
            tier4_sensing_launch
            tier4_simulation_msgs
            tier4_simulator_launch
            tier4_state_rviz_plugin
            tier4_system_launch
            tier4_system_rviz_plugin
            tier4_traffic_light_rviz_plugin
            tier4_v2x_msgs
            tier4_vehicle_launch
            tier4_vehicle_rviz_plugin
            yabloc_common
            yabloc_image_processing
            yabloc_monitor
            yabloc_particle_filter
            yabloc_pose_initializer

  rolling:
    runs-on: ubuntu-24.04
    steps:
      - uses: jspricke/ros-deb-builder-action@main
        with:
          ROS_DISTRO: rolling
          DEB_DISTRO: noble
          ROSDEP_SOURCE: "yaml https://github.com/nobleo/ros_debian_packages/raw/main/rosdep/source.yaml"
          # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} only on main branch
          GITHUB_TOKEN: "${{ github.ref == 'refs/heads/main' && secrets.GITHUB_TOKEN || '' }}"
          REPOS_FILE: rolling.repos
          GIT_LFS: true
          SBUILD_CONF: '$enable_network = 1;'  # For rmw_zenoh and novatel
